---
title: "Results"
format:
    html:
        theme: cosmo
        toc: true
        df-print: kable
        self-contained: true
execute:
    echo: true
    warning: false
    error: false
---

::: {.panel-tabset}

## Overall sample

### Inclusion flow diagram

```{r}
library(targets)
library(survival)
library(data.table)

flow <- as.data.table(tar_read(selection_process))
flow[, `:=`(
    Total_cohort = total_cohort,
    Agreed_accel_study = accel_available,
    Valid_accel_data = GGIR_checks,
    No_prev_dementia = no_prevalent_dementia,
    Aged_55_over = age_55_over
)]

flow[, list(
    Total_cohort,
    Agreed_accel_study,
    Valid_accel_data,
    No_prev_dementia,
    Aged_55_over
)]

```

### Baseline characteristics

```{r}
#| tbl-cap: "Sample Characteristics"

library(gtsummary)

df <- as.data.table(tar_read(df))

df[, list(
    age_accel,
    sex,
    ethnicity,
    highest_qual,
    employ,
    shift,
    BMI,
    bp_syst_avg,
    smok_status,
    avg_mvpa,
    alc_freq,
    apoe_e4,
    freq_depressed_twoweeks,
    prev_diabetes,
    prev_cvd,
    insomnia_med,
    sri,
    rri,
    IS
)] |>
    tbl_summary(
        statistic = list(
            all_continuous() ~ "{mean} ({sd})",
            all_categorical() ~ "{n} ({p}%)"
        ),
        label = list(
            age_accel ~ "Age (years)",
            sex ~ "Sex",
            ethnicity ~ "Ethnicity",
            BMI ~ "BMI (kg/m²)",
            sri ~ "Sleep regularity index",
            rri ~ "Rest Regularity index",
            IS ~ "Interdaily stability",
            avg_mvpa ~ "MVPA (min/day)",
            bp_syst_avg ~ "Systolic BP (mmHg)",
            smok_status ~ "Smoking status",
            alc_freq ~ "Alcohol frequency",
            highest_qual ~ "Highest education",
            shift ~ "Shift work",
            employ ~ "Employment status",
            apoe_e4 ~ "APOE ε4",
            freq_depressed_twoweeks ~ "Frequency depressed",
            prev_diabetes ~ "Prevalent Diabetes",
            prev_cvd ~ "Prevalent CVD",
            insomnia_med ~ "Insomnia Medication"
        ),
        missing_text = "Missing"
    ) |>
    modify_caption("**Table 1. Baseline Sample Characteristics**") |>
    bold_labels()


```

### Testing proportional hazards

#### SRI

```{r}
plot(tar_read(schoenfeld_sri_model1), var = 1)
```

#### RRI

```{r}
library(targets)
plot(tar_read(schoenfeld_rri_model1), var = 1)
```

#### IS

```{r}
library(targets)
plot(tar_read(schoenfeld_IS_model1), var = 1)
```

### P values for age + sex interaction & linearity

```{r}
tar_read(assumption_checks_all)
```

### Spline model visualizations
### Model1

```{r}
#| echo: false
tar_read(spline_plots_sri_model1_all)
tar_read(spline_plots_rri_model1_all)
tar_read(spline_plots_IS_model1_all)
```

### Model2

```{r}
#| echo: false
tar_read(spline_plots_sri_model2_all)
tar_read(spline_plots_rri_model2_all)
tar_read(spline_plots_IS_model2_all)
```

### Hazard ratio estimates - Continuous

```{r}
tar_read(pooled_estimates_all)
```

### Hazard ratio estimates - Categorical

```{r}
tar_read(pooled_estimates_cat_all)
```

## Males

### P values for age + sex interaction & linearity

```{r}
tar_read(assumption_checks_males)
```

### Spline model visualizations
### Model1

```{r}
#| echo: false
tar_read(spline_plots_sri_model1_males)
tar_read(spline_plots_rri_model1_males)
tar_read(spline_plots_IS_model1_males)
```

### Model2

```{r}
#| echo: false
tar_read(spline_plots_sri_model2_males)
tar_read(spline_plots_rri_model2_males)
tar_read(spline_plots_IS_model2_males)
```

### Hazard ratio estimates - Continuous

```{r}
tar_read(pooled_estimates_males)
```

### Hazard ratio estimates - Categorical

```{r}
tar_read(pooled_estimates_cat_males)
```

## Females

### P values for age + sex interaction & linearity

```{r}
tar_read(assumption_checks_females)
```

### Spline model visualizations
### Model1

```{r}
#| echo: false
tar_read(spline_plots_sri_model1_females)
tar_read(spline_plots_rri_model1_females)
tar_read(spline_plots_IS_model1_females)
```

### Model2

```{r}
#| echo: false
tar_read(spline_plots_sri_model2_females)
tar_read(spline_plots_rri_model2_females)
tar_read(spline_plots_IS_model2_females)
```

### Hazard ratio estimates - Continuous

```{r}
tar_read(pooled_estimates_females)
```

### Hazard ratio estimates - Categorical

```{r}
tar_read(pooled_estimates_cat_females)
```

## Aged 55-65 years

### P values for age + sex interaction & linearity

```{r}
tar_read(assumption_checks_under_65)
```

### Spline model visualizations
### Model1

```{r}
#| echo: false
tar_read(spline_plots_sri_model1_under_65)
tar_read(spline_plots_rri_model1_under_65)
tar_read(spline_plots_IS_model1_under_65)
```

### Model2

```{r}
#| echo: false
tar_read(spline_plots_sri_model2_under_65)
tar_read(spline_plots_rri_model2_under_65)
tar_read(spline_plots_IS_model2_under_65)
```

### Hazard ratio estimates - Continuous

```{r}
tar_read(pooled_estimates_under_65)
```

### Hazard ratio estimates - Categorical

```{r}
tar_read(pooled_estimates_cat_under_65)
```

## Aged 65-75 years

### P values for age + sex interaction & linearity

```{r}
tar_read(assumption_checks_65_to_75)
```

### Spline model visualizations
### Model1

```{r}
#| echo: false
tar_read(spline_plots_sri_model1_65_to_75)
tar_read(spline_plots_rri_model1_65_to_75)
tar_read(spline_plots_IS_model1_65_to_75)
```

### Model2

```{r}
#| echo: false
tar_read(spline_plots_sri_model2_65_to_75)
tar_read(spline_plots_rri_model2_65_to_75)
tar_read(spline_plots_IS_model2_65_to_75)
```

### Hazard ratio estimates - Continuous

```{r}
tar_read(pooled_estimates_65_to_75)
```

### Hazard ratio estimates - Categorical

```{r}
tar_read(pooled_estimates_cat_65_to_75)
```

## Aged 75+

### P values for age + sex interaction & linearity

```{r}
tar_read(assumption_checks_75_and_over)
```

### Spline model visualizations
### Model1

```{r}
#| echo: false
tar_read(spline_plots_sri_model1_75_and_over)
tar_read(spline_plots_rri_model1_75_and_over)
tar_read(spline_plots_IS_model1_75_and_over)
```

### Model2

```{r}
#| echo: false
tar_read(spline_plots_sri_model2_75_and_over)
tar_read(spline_plots_rri_model2_75_and_over)
tar_read(spline_plots_IS_model2_75_and_over)
```

### Hazard ratio estimates - Continuous

```{r}
tar_read(pooled_estimates_75_and_over)
```

### Hazard ratio estimates - Categorical

```{r}
tar_read(pooled_estimates_cat_75_and_over)
```

## Males aged 55-65 years

### P values for age + sex interaction & linearity

```{r}
tar_read(assumption_checks_under_65_males)
```

### Spline model visualizations
### Model1

```{r}
#| echo: false
tar_read(spline_plots_sri_model1_under_65_males)
tar_read(spline_plots_rri_model1_under_65_males)
tar_read(spline_plots_IS_model1_under_65_males)
```

### Model2

```{r}
#| echo: false
tar_read(spline_plots_sri_model2_under_65_males)
tar_read(spline_plots_rri_model2_under_65_males)
tar_read(spline_plots_IS_model2_under_65_males)
```

### Hazard ratio estimates - Continuous

```{r}
tar_read(pooled_estimates_under_65_males)
```

### Hazard ratio estimates - Categorical

```{r}
tar_read(pooled_estimates_cat_under_65_males)
```

## Females aged 55-65 years

### P values for age + sex interaction & linearity

```{r}
tar_read(assumption_checks_under_65_females)
```

### Spline model visualizations
### Model1

```{r}
#| echo: false
tar_read(spline_plots_sri_model1_under_65_females)
tar_read(spline_plots_rri_model1_under_65_females)
tar_read(spline_plots_IS_model1_under_65_females)
```

### Model2

```{r}
#| echo: false
tar_read(spline_plots_sri_model2_under_65_females)
tar_read(spline_plots_rri_model2_under_65_females)
tar_read(spline_plots_IS_model2_under_65_females)
```

### Hazard ratio estimates - Continuous

```{r}
tar_read(pooled_estimates_under_65_females)
```

### Hazard ratio estimates - Categorical

```{r}
tar_read(pooled_estimates_cat_under_65_females)
```

## Males aged 65-75 years
### P values for age + sex interaction & linearity

```{r}
tar_read(assumption_checks_65_to_75_males)
```

### Spline model visualizations
### Model1

```{r}
#| echo: false
tar_read(spline_plots_sri_model1_65_to_75_males)
tar_read(spline_plots_rri_model1_65_to_75_males)
tar_read(spline_plots_IS_model1_65_to_75_males)
```

### Model2

```{r}
#| echo: false
tar_read(spline_plots_sri_model2_65_to_75_males)
tar_read(spline_plots_rri_model2_65_to_75_males)
tar_read(spline_plots_IS_model2_65_to_75_males)
```

### Hazard ratio estimates - Continuous

```{r}
tar_read(pooled_estimates_65_to_75_males)
```

### Hazard ratio estimates - Categorical

```{r}
tar_read(pooled_estimates_cat_65_to_75_males)
```

## Females aged 65-75 years
### P values for age + sex interaction & linearity

```{r}
tar_read(assumption_checks_65_to_75_females)
```

### Spline model visualizations
### Model1

```{r}
#| echo: false
tar_read(spline_plots_sri_model1_65_to_75_females)
tar_read(spline_plots_rri_model1_65_to_75_females)
tar_read(spline_plots_IS_model1_65_to_75_females)
```

### Model2

```{r}
#| echo: false
tar_read(spline_plots_sri_model2_65_to_75_females)
tar_read(spline_plots_rri_model2_65_to_75_females)
tar_read(spline_plots_IS_model2_65_to_75_females)
```

### Hazard ratio estimates - Continuous

```{r}
tar_read(pooled_estimates_65_to_75_females)
```

### Hazard ratio estimates - Categorical

```{r}
tar_read(pooled_estimates_cat_65_to_75_females)
```

## Sensitivity analysis - Firth correction

```{r}
rbindlist(list(
    tar_read(pooled_estimates_firth_all),
    tar_read(pooled_estimates_firth_males),
    tar_read(pooled_estimates_firth_females),
    tar_read(pooled_estimates_firth_under_65),
    tar_read(pooled_estimates_firth_65_to_75),
    tar_read(pooled_estimates_firth_75_and_over),
    tar_read(pooled_estimates_firth_under_65_males),
    tar_read(pooled_estimates_firth_under_65_females),
    tar_read(pooled_estimates_firth_65_to_75_males),
    tar_read(pooled_estimates_firth_65_to_75_females)
))
```
